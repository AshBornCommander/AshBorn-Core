# main.py  ‚Äì AshBorn core launcher

import os, threading, asyncio
from datetime import datetime
from dotenv import load_dotenv
from loguru import logger

# ‚îÄ‚îÄ Optional colour output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
try:
    from colorama import Fore, Style
except ImportError:          # safe fallback if colorama missing
    class Dummy:
        def __getattr__(self, _):  # noqa
            return ""
    Fore = Style = Dummy()
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

from bot.realtime      import watch_command_file          # üîÅ command.txt watcher
from bot.telegram_bot  import start_telegram_bot          # üì≤ Telegram listener
from bot.alpha_sniffer import start_sniffer_loop          # üîé Solana token watcher
from bot.brain         import launch_background_tasks     # üß† Alpha-Brain loop

# ‚îÄ‚îÄ ENV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load_dotenv()
BOT_NAME  = os.getenv("BOT_NAME", "AshBorn")
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# ‚îÄ‚îÄ Logger ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
logger.remove()
logger.add(lambda msg: print(msg, end=""), level=LOG_LEVEL)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


def _start_telegram_thread() -> None:
    """Runs Telegram polling in its own daemon thread."""
    threading.Thread(
        target=start_telegram_bot,
        name="TelegramThread",
        daemon=True
    ).start()


def _start_sniffer_thread() -> None:
    """
    Runs the async alpha-sniffer loop in its own daemon thread
    *and* schedules the Brain‚Äôs alpha-watcher on the same loop.
    """
    def _runner() -> None:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)

        # ‚îÄ‚îÄ üß† Schedule Brain watcher on this loop ‚îÄ‚îÄ
        launch_background_tasks(loop)

        # ‚îÄ‚îÄ üîé Run sniffer loop forever ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        loop.run_until_complete(start_sniffer_loop())

    threading.Thread(
        target=_runner,
        name="SnifferThread",
        daemon=True
    ).start()


def main() -> None:
    """AshBorn boot sequence."""
    logger.info(
        Fore.CYAN
        + f"\nü§ñ [{BOT_NAME}] is waking up at {datetime.now().isoformat()} ‚Ä¶\n"
        + Style.RESET_ALL
    )

    # 1Ô∏è‚É£  Telegram remote-control interface
    _start_telegram_thread()

    # 2Ô∏è‚É£  Alpha-Sniffer + Brain alpha-watcher
    _start_sniffer_thread()

    # 3Ô∏è‚É£  Local command-file watcher (blocks forever)
    watch_command_file()   # <‚Äî continuous loop


# ‚îÄ‚îÄ Entry-point guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if __name__ == "__main__":
    main()
